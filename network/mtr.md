# 2.7.2 使用 mtr 探测网络质量

如果两个节点之间延迟很大，我们该如何定位中间的链路问题呢？

这种情况我们可以使用 mtr 工具进行排查。mtr 的全称是 my traceroute，它综合 ping、traceroute、nslookup 等相关功能，能显示目的地之间中间链路不断更新的延迟和丢包信息，mtr 可让我们实时看到网络路径状况，更直观地排查网络问题。

## 1. mtr 应用示例

在本节我们对 `www.iq.com` 进行网络质量观测，并对观测结果进行解读，以供读者参考。

开启命令查看 MTR 报告

```
mtr -z www.iq.com
```
<div  align="center">
	<img src="../assets/mtr.png" width = "600"  align=center />
	<p>图: MTR 报告</p>
</div>


## 2. mtr 报告分析

输出的列参数含义为：

- 跳数
- AS 号
- 路由 IP 地址
- 丢包率 Loss
- 已发送包数 Snt
- 最后一个包延迟 Last
- 平均延迟 Avg
- 最低延迟 Best
- 最差延迟 Wrst
- 稳定性 StDev

在大多数情况下，我们可以把 MTR 输出分成三大块:

- 根据配置，第二或第三跳一般本地 ISP。
- 中间节点是数据包经过的各类骨干网络路由。
- 倒数第二或第三跳一般为目的主机 ISP。

### 2.1 根据 AS 判断路由途径

通过 AS 号可以获知途径的自治网络，本节案例的测试路径如下：

1. AS24400（上海移动）
2. AS9808(广东移动)
3. 移动的CMI境外骨干网 (AS58453)
4. AS20940 (Akamai自治系统 )  

iq.com 节点位于新加坡。未使用动态加速的情况下，中国大陆用户会从 AS58453 路由到 AS749（美国），兜了一个大圈才到新加坡。
上面路径也说明了一个事实：**各 ISP 之间的网络途径很多情况下不是最优解，而是费用最低的选择策略。**

### 2.2 丢包以及延迟解析

MTR 的报告有两个核心指标: `loss 丢包率`、`latency 延迟`。

如果在任何一跳上看到 loss 的百分比，这就说明这一跳上可能有问题了，通过查看下一跳的丢包率，我们可以大概的判断出是人为的限制 ICMP 传输还是确定有丢包的现象。如上图中第四跳出现 90% 的丢包率，而第五跳则没有任何丢包，可以判断第四跳路由节点人为限制了 ICMP 传输。在 9、10、11 跳中，有连续出现丢包的情况，结合所处环境（移动境外骨干网），出现丢包的可能性很大。

延迟取决于节点之间的物理距离和线路质量，因为各个路由中间节点所处在不同位置以及不同的自治网络，延迟通常会随着跳数以及跨自治网络而增加。在上图中，可以看到在经过第九跳时，延迟增大至 37ms。再具体分析 AS58453 属于移动的出海国际线路，必定存在较高的延迟率。
